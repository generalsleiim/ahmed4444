<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <title>Ù†Ø¸Ø§Ù… Ø¹Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…ØªØ·ÙˆØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
  <style>
    body { background: #f0f0f0; }
    .tab-btn.active { background: #1565c0 !important; color: #fff !important; }
    .model-box { background: #e3f2fd; border-radius: 6px; margin: 10px 0; padding: 10px 15px; }
    .back-btn { margin: 10px 0 20px; }
    .settings-buttons button { margin-left: 8px; }
    .user-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
    .logout-btn { float: left; background: #f44336; color: #fff; border: none; border-radius: 5px; padding: 6px 16px; cursor: pointer; }
    .dark-mode { background: #23272f !important; color: #eee !important; }
    .dark-mode .model-box { background: #2d3542 !important; }
    .dark-mode .form-control, .dark-mode .form-select { background: #23272f; color: #eee; border-color: #444; }
    .dark-mode .table { color: #eee; }
    .lang-btn { float: right; margin-top: 10px; }
    .stat-card { background: #fff; border-radius: 8px; box-shadow: 0 0 10px #0001; padding: 15px; margin-bottom: 15px; }
    .chart-bar { height: 18px; background: #2196f3; border-radius: 4px; }
    .file-link { font-size: 13px; color: #1565c0; }
  </style>
</head>
<body>
  <div id="login-screen" class="container text-center mt-5">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input id="login-username" class="form-control my-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="max-width:250px;display:inline-block;"/><br/>
    <input id="login-password" class="form-control my-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="max-width:250px;display:inline-block;" type="password"/><br/>
    <button onclick="login()" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
    <div id="login-msg" style="color:red; margin-top:10px;"></div>
  </div>
  <div id="main-app" style="display:none;">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
        <h2>Ù†Ø¸Ø§Ù… Ø¹Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…ØªØ·ÙˆØ±</h2>
        <div>
          <button class="btn btn-danger logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
          <button class="btn btn-secondary lang-btn" onclick="toggleLang()">EN/AR</button>
          <button class="btn btn-dark" onclick="toggleDarkMode()" id="darkBtn">ğŸŒ™</button>
        </div>
      </div>
      <ul class="nav nav-tabs mb-3" id="mainTabs">
        <li class="nav-item"><button class="nav-link tab-btn active" id="tab-entries" onclick="showSection('entries')">Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª</button></li>
        <li class="nav-item"><button class="nav-link tab-btn" id="tab-settings" onclick="showSection('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></li>
        <li class="nav-item"><button class="nav-link tab-btn" id="tab-users" onclick="showSection('users')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button></li>
        <li class="nav-item"><button class="nav-link tab-btn" id="tab-stats" onclick="showSection('stats')">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button></li>
        <li class="nav-item"><button class="nav-link tab-btn" id="tab-dataview" onclick="showSection('dataview')">Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button></li>
      </ul>
      <div id="notif-area"></div>
      <div id="content-area"></div>
    </div>
  </div>
<script>
let sections = {
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ù†": ["Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ", "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª"],
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©": ["Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", "Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©"],
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†": ["Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø®Ø§Ù…Ø§Øª", "Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù…", "Ù…Ø®Ø§Ø²Ù† Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±"],
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª": ["Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ"]
};
let modelTemplates = {
  "Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ": [{name:"Ø§Ù„Ø§Ø³Ù…",type:"text"},{name:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date"}],
  "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª": [{name:"Ø§Ù„Ù…ÙˆÙ‚Ø¹",type:"text"},{name:"Ø§Ù„Ø­Ø§Ù„Ø©",type:"select",options:"Ø¬ÙŠØ¯,Ù…Ø¹Ø·Ù„"}],
  "Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©": [{name:"Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ",type:"text"},{name:"ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø©",type:"date"}],
  "Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©": [{name:"Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ",type:"text"},{name:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª",type:"text"}],
  "Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ø®Ø§Ù…Ø§Øª": [{name:"Ø§Ù„ØµÙ†Ù",type:"text"},{name:"Ø§Ù„ÙƒÙ…ÙŠØ©",type:"number"}],
  "Ù…Ø®Ø§Ø²Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªØ§Ù…": [{name:"Ø§Ù„Ù…Ù†ØªØ¬",type:"text"},{name:"Ø§Ù„Ø¹Ø¯Ø¯",type:"number"}],
  "Ù…Ø®Ø§Ø²Ù† Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±": [{name:"Ø§Ù„Ù‚Ø·Ø¹Ø©",type:"text"},{name:"Ø§Ù„ÙƒÙ…ÙŠØ©",type:"number"}],
  "Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø±ÙŠØ± Ù…Ø§Ù„ÙŠ": [{name:"Ø§Ù„Ù…Ø¨Ù„Øº",type:"number"},{name:"Ø§Ù„ØªØ§Ø±ÙŠØ®",type:"date"}]
};
let entries = {};
let users = [
  {username:"general", password:"generalsleiim", permissions:["*"], roles:{}}
];
let currentUser = null;
let logs = [];
let lang = "ar";
let darkMode = false;

const tr = {
  "ar": {
    "login": "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
    "username": "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
    "password": "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
    "loginBtn": "Ø¯Ø®ÙˆÙ„",
    "wrongLogin": "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©!",
    "logout": "Ø®Ø±ÙˆØ¬",
    "entries": "Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª",
    "settings": "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
    "users": "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
    "stats": "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª",
    "addEntry": "Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ø¯ÙŠØ¯",
    "viewEntries": "Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª",
    "back": "Ø¹ÙˆØ¯Ø©",
    "save": "Ø­ÙØ¸",
    "fields": "Ø§Ù„Ø­Ù‚ÙˆÙ„",
    "editFields": "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„",
    "deleteModel": "Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬",
    "addModel": "Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯",
    "modelNamePrompt": "Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯:",
    "modelExists": "Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!",
    "confirmDeleteModel": "ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŸ",
    "addField": "Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„",
    "deleteField": "Ø­Ø°Ù",
    "fieldName": "Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„",
    "fieldType": "Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚Ù„",
    "fieldOptions": "Ø®ÙŠØ§Ø±Ø§Øª (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)",
    "noEntries": "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¯Ø®Ø§Ù„Ø§Øª.",
    "addUser": "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…",
    "editUser": "ØªØ¹Ø¯ÙŠÙ„",
    "deleteUser": "Ø­Ø°Ù",
    "userExists": "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯!",
    "userPermsPrompt": "Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ø£Ùˆ * Ù„Ù„ÙƒÙ„):",
    "userPerms": "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª",
    "all": "Ø§Ù„ÙƒÙ„",
    "confirmDeleteUser": "ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ",
    "rolePrompt": "Ø­Ø¯Ø¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (add:Ø¥Ø¶Ø§ÙØ©, edit:ØªØ¹Ø¯ÙŠÙ„, view:Ø¹Ø±Ø¶) Ù„ÙƒÙ„ Ù†Ù…ÙˆØ°Ø¬ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ù…Ø«Ø§Ù„: add,edit):",
    "roles": "Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",
    "file": "Ù…Ù„Ù",
    "chooseFile": "Ø§Ø®ØªØ± Ù…Ù„Ù",
    "fileUploaded": "ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù",
    "exportCSV": "ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel",
    "importCSV": "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel",
    "search": "Ø¨Ø­Ø«...",
    "filter": "ØªØµÙÙŠØ©",
    "notifyAdd": "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­",
    "notifyEdit": "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­",
    "notifyDelete": "ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­",
    "notifyMail": "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ!",
    "dark": "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ",
    "lang": "EN/AR",
    "statEntries": "Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª",
    "statUsers": "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
    "statModels": "Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬",
    "statMostActive": "Ø£ÙƒØ«Ø± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ù†Ø´Ø§Ø·Ù‹Ø§",
    "statUserActivity": "Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
    "addSection": "Ø¥Ø¶Ø§ÙØ© Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©",
    "sectionNamePrompt": "Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:",
    "sectionExists": "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!",
    "sectionAdded": "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
    "editSectionName": "ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
    "sectionNameUpdated": "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
    "editModelName": "ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬",
    "modelNameUpdated": "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬"
  },
  "en": {
    "login": "Login",
    "username": "Username",
    "password": "Password",
    "loginBtn": "Login",
    "wrongLogin": "Wrong credentials!",
    "logout": "Logout",
    "entries": "Entries",
    "settings": "Settings",
    "users": "Users",
    "stats": "Statistics",
    "addEntry": "Add Entry",
    "viewEntries": "View Entries",
    "back": "Back",
    "save": "Save",
    "fields": "Fields",
    "editFields": "Edit Fields",
    "deleteModel": "Delete Model",
    "addModel": "Add New Model",
    "modelNamePrompt": "New model name:",
    "modelExists": "Model already exists!",
    "confirmDeleteModel": "Confirm delete model?",
    "addField": "Add Field",
    "deleteField": "Delete",
    "fieldName": "Field Name",
    "fieldType": "Field Type",
    "fieldOptions": "Options (comma separated)",
    "noEntries": "No entries.",
    "addUser": "Add User",
    "editUser": "Edit",
    "deleteUser": "Delete",
    "userExists": "Username already exists!",
    "userPermsPrompt": "Enter allowed models separated by comma (* for all):",
    "userPerms": "Permissions",
    "all": "All",
    "confirmDeleteUser": "Confirm delete user?",
    "rolePrompt": "Set permissions (add,edit,view) for each model separated by comma (e.g.: add,edit):",
    "roles": "Advanced Permissions",
    "file": "File",
    "chooseFile": "Choose File",
    "fileUploaded": "File uploaded",
    "exportCSV": "Export to Excel",
    "importCSV": "Import from Excel",
    "search": "Search...",
    "filter": "Filter",
    "notifyAdd": "Added successfully",
    "notifyEdit": "Edited successfully",
    "notifyDelete": "Deleted successfully",
    "notifyMail": "Email sent!",
    "dark": "Dark Mode",
    "lang": "EN/AR",
    "statEntries": "Total Entries",
    "statUsers": "Total Users",
    "statModels": "Total Models",
    "statMostActive": "Most Active Models",
    "statUserActivity": "User Activity",
    "addSection": "Add New Section",
    "sectionNamePrompt": "New section name:",
    "sectionExists": "Section already exists!",
    "sectionAdded": "Section added",
    "editSectionName": "Edit Section Name",
    "sectionNameUpdated": "Section name updated",
    "editModelName": "Edit Model Name",
    "modelNameUpdated": "Model name updated"
  }
};
function loadEntriesFromServer(model, callback) {
  fetch('https://ahmed00930-production.up.railway.app/api/entries?model=' + encodeURIComponent(model))
    .then(res => res.json())
    .then(list => { if(callback) callback(list); });
}
function t(key) { return tr[lang][key]||key; }
function login() {
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value;
  const user = users.find(x=>x.username===u && x.password===p);
  if(user) {
    currentUser = user;
    document.getElementById('login-screen').style.display='none';
    document.getElementById('main-app').style.display='';
    showSection('entries');
    document.getElementById('login-msg').textContent = '';
  } else {
    document.getElementById('login-msg').textContent = t("wrongLogin");
  }
}
function logout() {
  currentUser = null;
  document.getElementById('main-app').style.display='none';
  document.getElementById('login-screen').style.display='';
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
}
function hasPermission(model, action="view") {
  if(!currentUser) return false;
  if(currentUser.permissions.includes("*")) return true;
  if(currentUser.permissions.includes(model)) return true;
  if(currentUser.roles && currentUser.roles[model]) return currentUser.roles[model].includes(action);
  return false;
}
function showSection(section) {
  document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
  document.getElementById('tab-'+section).classList.add('active');
  if(section==='entries') renderEntries();
  else if(section==='settings') renderSettings();
  else if(section==='users') renderUsers();
  else if(section==='stats') renderStats();
  else if(section==='dataview') renderDataView();
}
function notify(msg, type="success") {
  let area = document.getElementById('notif-area');
  area.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(()=>{area.innerHTML="";},2000);
}
function renderEntries() {
  let html = '';
  for(const sec in sections) {
    let models = sections[sec].filter(m=>hasPermission(m,"view"));
    if(models.length===0) continue;
    html += `<div class="card mb-3"><div class="card-body"><h5>${sec}</h5>`;
    models.forEach(model=>{
      html += `<div class="model-box">
        <b>${model}</b>
        ${hasPermission(model,"add")?`<button class="btn btn-sm btn-primary ms-2" onclick="showEntryForm('${model}')">${t("addEntry")}</button>`:""}
        <button class="btn btn-sm btn-secondary" onclick="showEntriesList('${model}')">${t("viewEntries")}</button>
      </div>`;
    });
    html += `</div></div>`;
  }
  document.getElementById('content-area').innerHTML = html;
}
function showEntryForm(model) {
  if(!hasPermission(model,"add")) return;
  let fields = modelTemplates[model]||[];
  let html = `<div class="card mb-3"><div class="card-body">
    <button class="btn btn-secondary back-btn" onclick="renderEntries()">${t("back")}</button>
    <h5>${t("addEntry")}: ${model}</h5>
    <form id="entry-form">`;
  fields.forEach((f,i)=>{
    html += `<div class="mb-2">
      <label>${f.name}:</label>
      ${renderFieldInput(f, '', 'field'+i)}
    </div>`;
  });
  html += `<button type="submit" class="btn btn-success">${t("save")}</button></form></div></div>`;
  document.getElementById('content-area').innerHTML = html;
  fields.forEach((f,i)=>{
    if(f.type==="file") document.getElementById('field'+i).onchange = function(e){
      if(e.target.files.length) notify(t("fileUploaded"),"info");
    };
  });
  document.getElementById('entry-form').onsubmit = function(e){
    e.preventDefault();
    let obj = {};
    fields.forEach((f,i)=>{
      if(f.type==="file") {
        let fileInput = document.getElementById('field'+i);
        obj[f.name]=fileInput.files.length?fileInput.files[0].name:"";
        obj["__file_"+f.name]=fileInput.files.length?fileInput.files[0]:null;
      } else {
        obj[f.name]=document.getElementById('field'+i).value;
      }
    });
    saveEntryToServer(model, {...obj, __user:currentUser.username, __date:new Date().toLocaleString()}, function() {
  notify(t("notifyAdd"));
  renderEntries();
});
};
}
function showEntriesList(model) {
  if(!hasPermission(model,"view")) return;
  loadEntriesFromServer(model, function(list) {
  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ù… list Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
});
  let fields = modelTemplates[model]||[];
  let html = `<div class="card mb-3"><div class="card-body">
    <button class="btn btn-secondary back-btn" onclick="renderEntries()">${t("back")}</button>
    <h5>${model} - ${t("viewEntries")}</h5>
    <input class="form-control mb-2" id="searchBox" placeholder="${t("search")}" oninput="filterTable('${model}')"/>
    <button class="btn btn-sm btn-outline-success mb-2" onclick="exportCSV('${model}')">${t("exportCSV")}</button>
    <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importCSV(event,'${model}')"/>
    <button class="btn btn-sm btn-outline-primary mb-2" onclick="document.getElementById('importFile').click()">${t("importCSV")}</button>
    `;
  if(list.length===0) html += `<div>${t("noEntries")}</div>`;
  else {
    html += `<div style="overflow-x:auto;"><table class="table table-bordered" id="entriesTable"><thead><tr>`;
    fields.forEach(f=>html+=`<th>${f.name}</th>`);
    html += `<th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªØµØ¯ÙŠØ±</th>`;
    html += `</tr></thead><tbody>`;
    list.forEach((row,idx)=>{
      html += `<tr>`;
      fields.forEach(f=>{
        if(f.type==="file" && row["__file_"+f.name])
          html+=`<td><span class="file-link" onclick="downloadFile('${model}',${idx},'${f.name}')">${row[f.name]}</span></td>`;
        else
          html+=`<td>${row[f.name]||''}</td>`;
      });
      html += `<td>${row.__user||""}</td><td>${row.__date||""}</td>`;
      html += `<td>
        <button class="btn btn-sm btn-success" onclick="exportSingleEntry('${model}',${idx})">Excel</button>
        <button class="btn btn-sm btn-primary" onclick="sendMail('${model}',${idx})">Gmail</button>
        <button class="btn btn-sm btn-success" style="background:#25D366;border:none" onclick="sendWhatsApp('${model}',${idx})">WhatsApp</button>
      </td>`;
      html += `</tr>`;
    });
    html += `</tbody></table></div>`;
  }
  html += `</div></div>`;
  document.getElementById('content-area').innerHTML = html;
}
function filterTable(model) {
  let val = document.getElementById('searchBox').value.toLowerCase();
  let table = document.getElementById('entriesTable');
  if(!table) return;
  for(let i=1;i<table.rows.length;i++) {
    let row = table.rows[i];
    let show = false;
    for(let j=0;j<row.cells.length;j++) {
      if(row.cells[j].innerText.toLowerCase().includes(val)) show=true;
    }
    row.style.display = show?"":"none";
  }
}
function exportCSV(model) {
  loadEntriesFromServer(model, function(list) {
  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ù… list Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
});
  if(list.length===0) return;
  let fields = modelTemplates[model]||[];
  let csv = fields.map(f=>f.name).concat(["Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…","Ø§Ù„ØªØ§Ø±ÙŠØ®"]).join(",")+"\n";
  list.forEach(row=>{
    let arr = fields.map(f=>`"${(row[f.name]||"").replace(/"/g,'""')}"`);
    arr.push(`"${row.__user||""}"`); arr.push(`"${row.__date||""}"`);
    csv += arr.join(",")+"\n";
  });
  let blob = new Blob([csv],{type:"text/csv"});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = model+".csv";
  a.click();
}
function importCSV(e,model) {
  let file = e.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(ev){
    let lines = ev.target.result.split("\n").filter(x=>x.trim());
    let fields = modelTemplates[model]||[];
    let header = lines[0].split(",");
    for(let i=1;i<lines.length;i++){
      let vals = lines[i].split(",");
      let obj = {};
      fields.forEach((f,idx)=>obj[f.name]=vals[idx]?vals[idx].replace(/^"|"$/g,""):"");
      obj.__user = vals[fields.length]?vals[fields.length].replace(/^"|"$/g,""):"";
      obj.__date = vals[fields.length+1]?vals[fields.length+1].replace(/^"|"$/g,""):"";
      saveEntryToServer(model, {...obj, __user:currentUser.username, __date:new Date().toLocaleString()}, function() {
  notify("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
  renderEntries(); // Ø£Ùˆ Ø£ÙŠ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
});
    }
  };
  reader.readAsText(file);
};
function downloadFile(model, idx, fname) {
  let file = entries[model][idx]["__file_"+fname];
  if(!file) return;
  let url = URL.createObjectURL(file);
  let a = document.createElement('a');
  a.href = url;
  a.download = file.name;
  a.click();
}
function renderSettings() {
  let html = `<div class="card mb-3"><div class="card-body"><h5>${t("settings")}</h5>
    <button class="btn btn-sm btn-info mb-3" onclick="addSection()">${t("addSection")}</button>
  `;
  for(const sec in sections) {
    html += `<div style="margin-bottom:18px;">
      <b>${sec}</b>
      <button class="btn btn-sm btn-outline-warning ms-2" onclick="editSectionName('${sec}')">${t("editSectionName")}</button>
    `;
    sections[sec].forEach(model=>{
      html += `<div class="model-box">
        <b>${model}</b>
        <div class="settings-buttons">
          <button class="btn btn-sm btn-secondary" onclick="editModelName('${sec}','${model}')">${t("editModelName")}</button>
          <button class="btn btn-sm btn-warning" onclick="editFields('${model}')">${t("editFields")}</button>
          <button class="btn btn-sm btn-danger" onclick="deleteModel('${sec}','${model}')">${t("deleteModel")}</button>
        </div>
        <div style="margin-top:5px;">
          <small>${t("fields")}: ${modelTemplates[model]?.map(f=>f.name).join(', ')||''}</small>
        </div>
      </div>`;
    });
    html += `<button class="btn btn-sm btn-success mt-2" onclick="addModel('${sec}')">${t("addModel")}</button></div>`;
  }
  html += `</div></div>`;
  document.getElementById('content-area').innerHTML = html;
}
function addSection() {
  let name = prompt(t("sectionNamePrompt"));
  if(!name) return;
  if(sections[name]) { alert(t("sectionExists")); return; }
  sections[name]=[];
  notify(t("sectionAdded"));
  renderSettings();
}
function editSectionName(oldName) {
  let newName = prompt(t("sectionNamePrompt"), oldName);
  if(!newName || newName === oldName) return;
  if(sections[newName]) { alert(t("sectionExists")); return; }
  sections[newName] = sections[oldName];
  delete sections[oldName];
  notify(t("sectionNameUpdated"));
  renderSettings();
}
function editModelName(sec, oldName) {
  let newName = prompt(t("modelNamePrompt"), oldName);
  if(!newName || newName === oldName) return;
  if(modelTemplates[newName]) { alert(t("modelExists")); return; }
  // ØªØ­Ø¯ÙŠØ« ÙÙŠ sections
  let idx = sections[sec].indexOf(oldName);
  if(idx !== -1) sections[sec][idx] = newName;
  // ØªØ­Ø¯ÙŠØ« ÙÙŠ modelTemplates
  modelTemplates[newName] = modelTemplates[oldName];
  delete modelTemplates[oldName];
  // ØªØ­Ø¯ÙŠØ« ÙÙŠ entries
  if(entries[oldName]) {
    entries[newName] = entries[oldName];
    delete entries[oldName];
  }
  // ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  users.forEach(u=>{
    if(u.permissions && Array.isArray(u.permissions)) {
      let i = u.permissions.indexOf(oldName);
      if(i !== -1) u.permissions[i] = newName;
    }
    if(u.roles && u.roles[oldName]) {
      u.roles[newName] = u.roles[oldName];
      delete u.roles[oldName];
    }
  });
  notify(t("modelNameUpdated"));
  renderSettings();
}
function editFields(model) {
  let fields = modelTemplates[model]||[];
  let html = `<div class="card mb-3"><div class="card-body">
    <button class="btn btn-secondary back-btn" onclick="renderSettings()">${t("back")}</button>
    <h5>${t("editFields")}: ${model}</h5>
    <form id="fields-form">`;
  fields.forEach((f,i)=>{
    html += `<div class="row mb-2">
      <div class="col-4"><input type="text" class="form-control" value="${f.name}" id="fname${i}" placeholder="${t("fieldName")}"/></div>
      <div class="col-3">
        <select class="form-select" id="ftype${i}">
          <option value="text" ${f.type==="text"?"selected":""}>Ù†Øµ</option>
          <option value="number" ${f.type==="number"?"selected":""}>Ø±Ù‚Ù…</option>
          <option value="date" ${f.type==="date"?"selected":""}>ØªØ§Ø±ÙŠØ®</option>
          <option value="time" ${f.type==="time"?"selected":""}>ÙˆÙ‚Øª</option>
          <option value="select" ${f.type==="select"?"selected":""}>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø©</option>
          <option value="file" ${f.type==="file"?"selected":""}>${t("file")}</option>
        </select>
      </div>
      <div class="col-4">
        <input type="text" class="form-control" id="fopts${i}" placeholder="${t("fieldOptions")}" value="${f.options||''}" ${f.type==="select"?"":"style='display:none;'"} />
      </div>
      <div class="col-1">
        <button type="button" class="btn btn-sm btn-danger" onclick="removeField('${model}',${i})">${t("deleteField")}</button>
      </div>
    </div>`;
  });
  html += `<button type="button" class="btn btn-sm btn-success" onclick="addField('${model}')">${t("addField")}</button>
    <button type="submit" class="btn btn-primary">${t("save")}</button></form></div></div>`;
  document.getElementById('content-area').innerHTML = html;
  fields.forEach((f,i)=>{
    document.getElementById('ftype'+i).onchange = function(){
      document.getElementById('fopts'+i).style.display = this.value==="select"?"":"none";
    };
  });
  document.getElementById('fields-form').onsubmit = function(e){
    e.preventDefault();
    let newFields = [];
    for(let i=0;i<fields.length;i++){
      let name = document.getElementById('fname'+i).value.trim();
      let type = document.getElementById('ftype'+i).value;
      let opts = document.getElementById('fopts'+i).value.trim();
      if(name) {
        let field = {name,type};
        if(type==="select" && opts) field.options=opts;
        newFields.push(field);
      }
    }
    modelTemplates[model]=newFields;
    notify(t("notifyEdit"));
    renderSettings();
  };
}
function addField(model) {
  modelTemplates[model].push({name:"",type:"text"});
  editFields(model);
}
function removeField(model, idx) {
  modelTemplates[model].splice(idx,1);
  editFields(model);
}
function addModel(sec) {
  let name = prompt(t("modelNamePrompt"));
  if(!name) return;
  if(modelTemplates[name]) { alert(t("modelExists")); return; }
  sections[sec].push(name);
  modelTemplates[name]=[{name:"Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯",type:"text"}];
  notify(t("notifyAdd"));
  renderSettings();
}
function deleteModel(sec, model) {
  if(!confirm(t("confirmDeleteModel"))) return;
  sections[sec]=sections[sec].filter(m=>m!==model);
  delete modelTemplates[model];
  delete entries[model];
  notify(t("notifyDelete"),"danger");
  renderSettings();
}
function renderUsers() {
  let html = `<div class="card mb-3"><div class="card-body"><h5>${t("users")}</h5>
    <button class="btn btn-sm btn-success mb-2" onclick="addUser()">${t("addUser")}</button>
    <div>`;
  users.forEach((u,i)=>{
    html += `<div class="user-row">
      <b>${u.username}</b>
      <button class="btn btn-sm btn-warning" onclick="editUser(${i})">${t("editUser")}</button>
      ${u.username!=="general"?`<button class="btn btn-sm btn-danger" onclick="deleteUser(${i})">${t("deleteUser")}</button>`:""}
      <span style="font-size:12px;color:#888;">${t("userPerms")}: ${u.permissions.includes("*")?t("all"):u.permissions.join(", ")}</span>
    </div>`;
  });
  html += `</div></div></div>`;
  document.getElementById('content-area').innerHTML = html;
}
function addUser() {
  let username = prompt(t("username"));
  if(!username) return;
  if(users.find(u=>u.username===username)) { alert(t("userExists")); return; }
  let password = prompt(t("password"));
  if(!password) return;
  let perms = choosePermissions();
  let roles = chooseRoles(perms);
  users.push({username,password,permissions:perms,roles});
  notify(t("notifyAdd"));
  renderUsers();
}
function editUser(idx) {
  let u = users[idx];
  let password = prompt(t("password"), u.password);
  if(!password) return;
  let perms = choosePermissions(u.permissions);
  let roles = chooseRoles(perms, u.roles);
  users[idx] = {username:u.username, password, permissions:perms, roles};
  notify(t("notifyEdit"));
  renderUsers();
}
function deleteUser(idx) {
  if(users[idx].username==="general") return;
  if(confirm(t("confirmDeleteUser"))) {
    users.splice(idx,1);
    notify(t("notifyDelete"),"danger");
    renderUsers();
  }
}
function choosePermissions(existing=[]) {
  let allModels = [];
  for(const sec in sections) allModels.push(...sections[sec]);
  let perms = prompt(t("userPermsPrompt")+"\n"+allModels.join(", "), existing.includes("*")?"*":existing.join(","));
  if(!perms) return [];
  perms = perms.split(",").map(x=>x.trim());
  if(perms.includes("*")) return ["*"];
  return perms.filter(x=>x);
}
function chooseRoles(perms, existing={}) {
  let roles = {};
  let models = perms.includes("*")?Object.values(sections).flat():perms;
  models.forEach(m=>{
    let val = prompt(`${m} - ${t("rolePrompt")}`, existing[m]?existing[m].join(","):"add,edit,view");
    if(val) roles[m]=val.split(",").map(x=>x.trim());
  });
  return roles;
}
function renderFieldInput(f, val, id) {
  if(f.type==="text") return `<input type="text" class="form-control" id="${id}" value="${val||''}"/>`;
  if(f.type==="number") return `<input type="number" class="form-control" id="${id}" value="${val||''}"/>`;
  if(f.type==="date") return `<input type="date" class="form-control" id="${id}" value="${val||''}"/>`;
  if(f.type==="time") return `<input type="time" class="form-control" id="${id}" value="${val||''}"/>`;
  if(f.type==="select") {
    let opts = (f.options||"").split(",").map(x=>x.trim());
    return `<select class="form-select" id="${id}">${opts.map(o=>`<option>${o}</option>`).join("")}</select>`;
  }
  if(f.type==="file") return `<input type="file" class="form-control" id="${id}"/>`;
  return `<input type="text" class="form-control" id="${id}" value="${val||''}"/>`;
}
function toggleDarkMode() {
  darkMode = !darkMode;
  document.body.classList.toggle("dark-mode", darkMode);
  document.getElementById("darkBtn").innerText = darkMode ? "â˜€ï¸" : "ğŸŒ™";
}
function toggleLang() {
  lang = lang==="ar"?"en":"ar";
  document.dir = lang==="ar"?"rtl":"ltr";
  document.body.style.textAlign = lang==="ar"?"right":"left";
  document.getElementById('login-username').placeholder = t("username");
  document.getElementById('login-password').placeholder = t("password");
  document.getElementById('login-screen').querySelector("h2").innerText = t("login");
  document.getElementById('login-screen').querySelector("button").innerText = t("loginBtn");
  showSection(document.querySelector('.tab-btn.active').id.replace("tab-",""));
}
function renderStats() {
  let totalEntries = Object.values(entries).reduce((a,b)=>a+b.length,0);
  let totalUsers = users.length;
  let totalModels = Object.values(sections).reduce((a,b)=>a+b.length,0);
  let modelCounts = {};
  for(let m in entries) modelCounts[m]=entries[m].length;
  let sortedModels = Object.entries(modelCounts).sort((a,b)=>b[1]-a[1]);
  let userCounts = {};
  logs.forEach(l=>{
    userCounts[l.user]=(userCounts[l.user]||0)+1;
  });
  let sortedUsers = Object.entries(userCounts).sort((a,b)=>b[1]-a[1]);
  let html = `<div class="row">
    <div class="col-md-4"><div class="stat-card"><b>${t("statEntries")}:</b> ${totalEntries}</div></div>
    <div class="col-md-4"><div class="stat-card"><b>${t("statUsers")}:</b> ${totalUsers}</div></div>
    <div class="col-md-4"><div class="stat-card"><b>${t("statModels")}:</b> ${totalModels}</div></div>
  </div>
  <div class="row">
    <div class="col-md-6"><div class="stat-card"><b>${t("statMostActive")}</b><br/>`;
  sortedModels.slice(0,5).forEach(([m,c])=>{
    html += `<div>${m} <div class="chart-bar" style="width:${c*20}px;display:inline-block"></div> (${c})</div>`;
  });
  html += `</div></div>
    <div class="col-md-6"><div class="stat-card"><b>${t("statUserActivity")}</b><br/>`;
  sortedUsers.slice(0,5).forEach(([u,c])=>{
    html += `<div>${u} <div class="chart-bar" style="width:${c*20}px;display:inline-block;background:#f44336"></div> (${c})</div>`;
  });
  html += `</div></div>
  </div>`;
  document.getElementById('content-area').innerHTML = html;
}

function renderDataView() {
  let html = '';
  for(const sec in sections) {
    html += `<div class="card mb-3"><div class="card-body"><h5>${sec}</h5>`;
    sections[sec].forEach(model=>{
      html += `<div class="model-box"><b>${model}</b>`;
      loadEntriesFromServer(model, function(list) {
        let fields = modelTemplates[model]||[];
        let innerHtml = '';
        if(list.length===0) {
          innerHtml += `<div style="color:#888">${t("noEntries")}</div>`;
        } else {
          innerHtml += `<div style="overflow-x:auto;"><table class="table table-bordered"><thead><tr>`;
          fields.forEach(f=>innerHtml+=`<th>${f.name}</th>`);
          innerHtml += `<th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªØµØ¯ÙŠØ±</th></tr></thead><tbody>`;
          list.forEach((row,idx)=>{
            innerHtml += `<tr>`;
            fields.forEach(f=>{
              if(f.type==="file" && row["__file_"+f.name])
                innerHtml+=`<td><span class="file-link" onclick="downloadFile('${model}',${idx},'${f.name}')">${row[f.name]}</span></td>`;
              else
                innerHtml+=`<td>${row[f.name]||''}</td>`;
            });
            innerHtml += `<td>${row.__user||""}</td><td>${row.__date||""}</td>`;
            innerHtml += `<td>
              <button class="btn btn-sm btn-success" onclick="exportSingleEntry('${model}',${idx})">Excel</button>
              <button class="btn btn-sm btn-primary" onclick="sendMail('${model}',${idx})">Gmail</button>
              <button class="btn btn-sm btn-success" style="background:#25D366;border:none" onclick="sendWhatsApp('${model}',${idx})">WhatsApp</button>
            </td>`;
            innerHtml += `</tr>`;
          });
          innerHtml += `</tbody></table></div>`;
        }
        // Ø¶Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        const container = document.getElementById(`dataview-${sec}-${model}`);
        if(container) container.innerHTML = innerHtml;
      });
      // Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª Ù„ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
      html += `<div id="dataview-${sec}-${model}"></div>`;
      html += `</div>`;
    });
    html += `</div></div>`;
  }
  document.getElementById('content-area').innerHTML = html;
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ±Ø¯ÙŠ
function exportSingleEntry(model, idx) {
  let entry = entries[model][idx];
  let fields = modelTemplates[model]||[];
  let csv = fields.map(f=>f.name).join(",")+"\n";
  csv += fields.map(f=>`"${(entry[f.name]||"").replace(/"/g,'""')}"`).join(",");
  let blob = new Blob([csv],{type:"text/csv"});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = model+"_entry.csv";
  a.click();
}
function sendMail(model, idx) {
  let entry = entries[model][idx];
  let fields = modelTemplates[model]||[];
  let body = fields.map(f=>`${f.name}: ${entry[f.name]||""}`).join('%0A');
  window.open(`https://mail.google.com/mail/?view=cm&fs=1&body=${body}`,'_blank');
}
function sendWhatsApp(model, idx) {
  let entry = entries[model][idx];
  let fields = modelTemplates[model]||[];
  let text = fields.map(f=>`${f.name}: ${entry[f.name]||""}`).join('%0A');
  window.open(`https://wa.me/?text=${text}`,'_blank');
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>